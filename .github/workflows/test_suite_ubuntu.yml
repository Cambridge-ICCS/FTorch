# Workflow to run the FTorch test suite on latest Ubuntu
name: TestSuiteUbuntu

# Controls when the workflow will run
on:
  # Triggers the workflow on pushes to the "main" branch, i.e., PR merges
  push:
    branches: [ "main" ]

  # Triggers the workflow on pushes to open pull requests with code changes
  pull_request:
    paths:
      - '.github/workflows/test_suite_ubuntu.yml'
      - '**.c'
      - '**.cpp'
      - '**.fypp'
      - '**.f90'
      - '**.F90'
      - '**.pf'
      - '**.py'
      - '**.sh'
      - '**CMakeLists.txt'
      - '**requirements.txt'
      - '**data/*'

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  test-suite-ubuntu:
    uses: Cambridge-ICCS/FTorch/.github/workflows/reusable_test_suite.yml@201_reusable-workflow
    with:
      os: ubuntu-latest
      shell: bash
      compiler: gfortran
      compiler-version: 11.4.0
      name: TestSuiteUbuntu
      install-command: |
          python -m pip install --upgrade pip
          python -m venv ftorch
          . ftorch/bin/activate
          pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu
      build-command: |
          . ftorch/bin/activate
          VN=$(python -c "import sys; print('.'.join(sys.version.split('.')[:2]))")
          export Torch_DIR=${VIRTUAL_ENV}/lib/python${VN}/site-packages
          export BUILD_DIR=$(pwd)/src/build
          mkdir ${BUILD_DIR}
          cd ${BUILD_DIR}
          cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=${BUILD_DIR} -DCMAKE_BUILD_TESTS=TRUE -DCMAKE_Fortran_FLAGS="-std=${{ matrix.std }}"
          cmake --build .
          cmake --install .
      test-command: |
          . ftorch/bin/activate
          ./run_integration_tests.sh -V
