# Workflow to validate the Spack package definition for FTorch
name: Spack Package Validation

# Controls when the workflow will run
on:
  # Triggers the workflow on pushes to the "main" branch, i.e., PR merges
  push:
    branches: [ "main" ]

  # Triggers the workflow on pushes to open pull requests with code changes
  pull_request:
    paths:
      # This workflow
      - '.github/workflows/spack_build.yml'
      # Package definition
      - 'package.py'

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Cancel jobs running if new commits are pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

# Write permissions are not required
permissions: {}

jobs:
  # Job 1: Validate Spack package syntax and concretization
  spack-validate:
    name: Validate Spack Package
    runs-on: ubuntu-22.04
    timeout-minutes: 15

    steps:
      - name: Checkout FTorch repository
        uses: actions/checkout@v5

      - name: Setup Spack
        uses: spack/setup-spack@v2
        with:
          ref: develop
          color: true

      - name: Add FTorch package to Spack
        run: |
          # Create a custom Spack repository for FTorch
          mkdir -p ftorch-repo/packages/ftorch
          cp package.py ftorch-repo/packages/ftorch/
          
          # Create repo.yaml for the custom repo
          echo "repo:" > ftorch-repo/repo.yaml
          echo "  namespace: ftorch" >> ftorch-repo/repo.yaml
          
          # Add the custom repo to Spack
          spack repo add $(pwd)/ftorch-repo

      - name: Validate package syntax
        run: |
          # Check that the package is recognized
          spack info ftorch
          
          # Validate package Python syntax
          python -m py_compile package.py
          echo "Package syntax is valid"

      - name: Test valid variant combinations
        run: |
          # Test successful concretization for all valid variant combinations
          
          echo "=== Base configuration (all GPU backends disabled) ==="
          spack spec ftorch@main~cuda~hip~xpu~mps~tests
          
          echo "=== With tests enabled ==="
          spack spec ftorch@main~cuda~hip~xpu~mps+tests
          
          echo "=== CUDA variant ==="
          spack spec ftorch@main+cuda~hip~xpu~mps~tests
          spack spec ftorch@main+cuda~hip~xpu~mps+tests
          
          echo "=== HIP variant ==="
          spack spec ftorch@main~cuda+hip~xpu~mps~tests
          spack spec ftorch@main~cuda+hip~xpu~mps+tests
          
          echo "=== XPU variant ==="
          spack spec ftorch@main~cuda~hip+xpu~mps~tests
          spack spec ftorch@main~cuda~hip+xpu~mps+tests
          
          echo "=== MPS variant (will fail on Linux platform) ==="
          # MPS should fail on Linux due to platform conflict
          if spack spec ftorch@main~cuda~hip~xpu+mps~tests 2>&1 | grep -q "conflicts"; then
            echo "PASS: MPS correctly conflicts on Linux platform"
          else
            echo "ERROR: MPS should conflict on Linux platform"
            exit 1
          fi
          
          echo "=== Shared library variants ==="
          spack spec ftorch@main~cuda~hip~xpu~mps+shared~tests
          spack spec ftorch@main~cuda~hip~xpu~mps~shared~tests
          
          echo "All valid variant combinations passed!"

      - name: Test conflicting GPU backend combinations (expected failures)
        run: |
          # Test that mutually exclusive GPU backends correctly fail
          
          echo "=== Testing CUDA + HIP conflict ==="
          if spack spec ftorch@main+cuda+hip 2>&1 | grep -q "conflicts"; then
            echo "PASS: +cuda+hip correctly failed with conflict"
          else
            echo "ERROR: +cuda+hip should have failed but didn't"
            exit 1
          fi
          
          echo "=== Testing CUDA + XPU conflict ==="
          if spack spec ftorch@main+cuda+xpu 2>&1 | grep -q "conflicts"; then
            echo "PASS: +cuda+xpu correctly failed with conflict"
          else
            echo "ERROR: +cuda+xpu should have failed but didn't"
            exit 1
          fi
          
          echo "=== Testing CUDA + MPS conflict ==="
          if spack spec ftorch@main+cuda+mps 2>&1 | grep -q "conflicts"; then
            echo "PASS: +cuda+mps correctly failed with conflict"
          else
            echo "ERROR: +cuda+mps should have failed but didn't"
            exit 1
          fi
          
          echo "=== Testing HIP + XPU conflict ==="
          if spack spec ftorch@main+hip+xpu 2>&1 | grep -q "conflicts"; then
            echo "PASS: +hip+xpu correctly failed with conflict"
          else
            echo "ERROR: +hip+xpu should have failed but didn't"
            exit 1
          fi
          
          echo "=== Testing HIP + MPS conflict ==="
          if spack spec ftorch@main+hip+mps 2>&1 | grep -q "conflicts"; then
            echo "PASS: +hip+mps correctly failed with conflict"
          else
            echo "ERROR: +hip+mps should have failed but didn't"
            exit 1
          fi
          
          echo "=== Testing XPU + MPS conflict ==="
          if spack spec ftorch@main+xpu+mps 2>&1 | grep -q "conflicts"; then
            echo "PASS: +xpu+mps correctly failed with conflict"
          else
            echo "ERROR: +xpu+mps should have failed but didn't"
            exit 1
          fi
          
          echo "=== Testing all GPU backends enabled (multiple conflicts) ==="
          if spack spec ftorch@main+cuda+hip+xpu+mps 2>&1 | grep -q "conflicts"; then
            echo "PASS: +cuda+hip+xpu+mps correctly failed with conflicts"
          else
            echo "ERROR: +cuda+hip+xpu+mps should have failed but didn't"
            exit 1
          fi
          
          echo "All conflict tests passed!"

  # Job 2: Build FTorch with CMake using pip-installed PyTorch
  # This validates the build process works, similar to other CI tests
  cmake-build:
    name: CMake Build Test
    runs-on: ubuntu-22.04
    timeout-minutes: 15

    steps:
      - name: Checkout FTorch repository
        uses: actions/checkout@v5

      - name: Install system packages
        run: |
          sudo apt-get update
          sudo apt-get install -y gfortran cmake

      - name: Setup Python and install PyTorch
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PyTorch via pip
        run: |
          python -m pip install --upgrade pip
          pip install torch --index-url https://download.pytorch.org/whl/cpu

      - name: Build FTorch with CMake
        run: |
          # Get PyTorch path
          TORCH_PATH=$(python -c "import torch; print(torch.__path__[0])")
          
          mkdir build && cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH="${TORCH_PATH}" \
            -DCMAKE_INSTALL_PREFIX="${PWD}/install"
          cmake --build .
          cmake --install .

      - name: Verify installation
        run: |
          # Verify key files were installed
          ls -la build/install/lib/
          ls -la build/install/include/
          
          if [[ ! -f "build/install/lib/libftorch.so" ]]; then
            echo "ERROR: libftorch.so not found"
            exit 1
          fi
          
          if [[ ! -f "build/install/include/ctorch.h" ]]; then
            echo "ERROR: ctorch.h not found"
            exit 1
          fi
          
          echo "Build and installation successful!"
