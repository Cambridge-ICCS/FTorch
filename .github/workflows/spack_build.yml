# Workflow to test building FTorch with Spack package manager
name: Spack Build Test

# Controls when the workflow will run
on:
  # Triggers the workflow on pushes to the "main" branch, i.e., PR merges
  push:
    branches: [ "main" ]

  # Triggers the workflow on pushes to open pull requests with code changes
  pull_request:
    paths:
      # This workflow
      - '.github/workflows/spack_build.yml'
      # Package definition
      - 'package.py'
      # Source files
      - 'src/**'
      # Build system
      - 'CMakeLists.txt'
      - 'cmake/**'

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Cancel jobs running if new commits are pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

# Write permissions are not required
permissions: {}

# Workflow run - one or more jobs that can run sequentially or in parallel
jobs:
  spack-build:
    name: Build with Spack
    runs-on: ubuntu-latest

    # Terminate the job if it runs for more than 30 minutes
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        python-version: [ "3.11", "3.12" ]
        variant: [ "", "+tests" ]

    steps:
      - name: Checkout FTorch repository
        uses: actions/checkout@v5

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install system packages for Spack externals
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            autoconf \
            automake \
            bison \
            bzip2 \
            cmake \
            coreutils \
            curl \
            diffutils \
            file \
            findutils \
            flex \
            gawk \
            gettext \
            gfortran \
            git \
            gmake \
            groff \
            gzip \
            libtool \
            m4 \
            make \
            ninja-build \
            openssh-client \
            openssl \
            patch \
            perl \
            pkg-config \
            python3 \
            python3-pip \
            python3-venv \
            rsync \
            sed \
            tar \
            unzip \
            wget \
            xz-utils \
            zlib1g-dev

      - name: Install Spack
        run: |
          git clone -b develop https://github.com/spack/spack.git
          export SPACK_ROOT=$(pwd)/spack
          source ${SPACK_ROOT}/share/spack/setup-env.sh
          spack --version

      - name: Setup Spack and Add FTorch package
        run: |
          export SPACK_ROOT=$(pwd)/spack
          source ${SPACK_ROOT}/share/spack/setup-env.sh
          
          # Configure compilers
          spack compiler find
          
          # Find and register external packages installed via apt
          spack external find --not-buildable
          
          # Show what externals were found
          echo "=== External packages found ==="
          spack external list
          
          # Create a custom Spack repository for FTorch
          mkdir -p ftorch-repo/packages/ftorch
          cp package.py ftorch-repo/packages/ftorch/
          
          # Create repo.yaml for the custom repo (avoid heredoc for YAML compatibility)
          echo "repo:" > ftorch-repo/repo.yaml
          echo "  namespace: ftorch" >> ftorch-repo/repo.yaml
          
          # Add the custom repo to Spack
          spack repo add $(pwd)/ftorch-repo
          
          # Verify repos and package
          spack repo list
          spack info ftorch

      - name: Build FTorch with Spack
        run: |
          export SPACK_ROOT=$(pwd)/spack
          source ${SPACK_ROOT}/share/spack/setup-env.sh
          
          # Build FTorch with specified variants
          # Dependencies (cmake, py-torch) are automatically installed
          spack install "ftorch@main~cuda${{ matrix.variant }}"

      - name: Verify installation
        run: |
          export SPACK_ROOT=$(pwd)/spack
          source ${SPACK_ROOT}/share/spack/setup-env.sh
          
          # Check library installation
          ftorch_prefix=$(spack location -i ftorch)
          
          echo "FTorch installed at: ${ftorch_prefix}"
          
          # Verify key files
          if [[ ! -f "${ftorch_prefix}/lib/libftorch.so" ]]; then
            echo "ERROR: libftorch.so not found at ${ftorch_prefix}/lib/"
            exit 1
          fi
          
          if [[ ! -f "${ftorch_prefix}/include/ctorch.h" ]]; then
            echo "ERROR: ctorch.h not found at ${ftorch_prefix}/include/"
            exit 1
          fi
          
          if [[ ! -f "${ftorch_prefix}/include/ftorch/ftorch.mod" ]]; then
            echo "ERROR: ftorch.mod not found at ${ftorch_prefix}/include/ftorch/"
            exit 1
          fi
          
          echo "All expected files found!"
          
          # List library contents
          nm ${ftorch_prefix}/lib/libftorch.so | head -20
