# Workflow to test building FTorch with Spack package manager
name: Spack Build Test

# Controls when the workflow will run
on:
  # Triggers the workflow on pushes to the "main" branch, i.e., PR merges
  push:
    branches: [ "main" ]

  # Triggers the workflow on pushes to open pull requests with code changes
  pull_request:
    paths:
      # This workflow
      - '.github/workflows/spack_build.yml'
      # Package definition
      - 'package.py'
      # Source files
      - 'src/**'
      # Build system
      - 'CMakeLists.txt'
      - 'cmake/**'

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Cancel jobs running if new commits are pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

# Write permissions are not required
permissions: {}

# Workflow run - one or more jobs that can run sequentially or in parallel
jobs:
  spack-build:
    name: Build with Spack
    runs-on: ubuntu-22.04

    # Terminate the job if it runs for more than 45 minutes
    timeout-minutes: 45

    strategy:
      fail-fast: false
      matrix:
        variant: [ "~tests", "+tests" ]

    steps:
      - name: Checkout FTorch repository
        uses: actions/checkout@v5

      - name: Install system packages
        run: |
          sudo apt-get update
          sudo apt-get install -y gfortran

      - name: Setup Python and install PyTorch
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PyTorch via pip
        run: |
          python -m pip install --upgrade pip
          pip install torch --index-url https://download.pytorch.org/whl/cpu
          # Get PyTorch installation path and version for Spack
          TORCH_PATH=$(python -c "import torch; print(torch.__path__[0])")
          TORCH_VERSION=$(python -c "import torch; print(torch.__version__.split('+')[0])")
          echo "TORCH_PATH=${TORCH_PATH}" >> $GITHUB_ENV
          echo "TORCH_VERSION=${TORCH_VERSION}" >> $GITHUB_ENV
          echo "PyTorch ${TORCH_VERSION} installed at: ${TORCH_PATH}"

      - name: Setup Spack
        uses: spack/setup-spack@v2
        with:
          ref: develop
          buildcache: true
          color: true

      - name: Add FTorch package to Spack
        run: |
          # Create a custom Spack repository for FTorch
          mkdir -p ftorch-repo/packages/ftorch
          cp package.py ftorch-repo/packages/ftorch/
          
          # Create repo.yaml for the custom repo
          echo "repo:" > ftorch-repo/repo.yaml
          echo "  namespace: ftorch" >> ftorch-repo/repo.yaml
          
          # Add the custom repo to Spack
          spack repo add $(pwd)/ftorch-repo
          
          # Configure compilers and externals
          spack compiler find
          spack external find --not-buildable cmake ninja
          
          # Configure PyTorch as an external package (installed via pip)
          # This avoids building py-torch and all its dependencies from source
          # Get the site-packages directory (parent of torch)
          TORCH_PREFIX=$(python -c "import torch; import os; print(os.path.dirname(torch.__path__[0]))")
          
          # Create packages.yaml entry for py-torch external
          mkdir -p ~/.spack
          echo "packages:" > ~/.spack/packages.yaml
          echo "  py-torch:" >> ~/.spack/packages.yaml
          echo "    buildable: false" >> ~/.spack/packages.yaml
          echo "    externals:" >> ~/.spack/packages.yaml
          echo "    - spec: py-torch@${TORCH_VERSION}" >> ~/.spack/packages.yaml
          echo "      prefix: ${TORCH_PREFIX}" >> ~/.spack/packages.yaml
          
          # Show the config
          echo "=== packages.yaml ==="
          cat ~/.spack/packages.yaml
          spack config get packages

          # Verify repos and package
          spack repo list
          spack info ftorch

      - name: Build FTorch with Spack
        run: |
          # Build FTorch with specified variants
          spack install "ftorch@main~cuda${{ matrix.variant }}"

      - name: Verify installation
        run: |
          # Check library installation
          ftorch_prefix=$(spack location -i ftorch)
          
          echo "FTorch installed at: ${ftorch_prefix}"
          
          # Verify key files
          if [[ ! -f "${ftorch_prefix}/lib/libftorch.so" ]]; then
            echo "ERROR: libftorch.so not found at ${ftorch_prefix}/lib/"
            exit 1
          fi
          
          if [[ ! -f "${ftorch_prefix}/include/ctorch.h" ]]; then
            echo "ERROR: ctorch.h not found at ${ftorch_prefix}/include/"
            exit 1
          fi
          
          if [[ ! -f "${ftorch_prefix}/include/ftorch/ftorch.mod" ]]; then
            echo "ERROR: ftorch.mod not found at ${ftorch_prefix}/include/ftorch/"
            exit 1
          fi
          
          echo "All expected files found!"
          
          # List library contents
          nm ${ftorch_prefix}/lib/libftorch.so | head -20
