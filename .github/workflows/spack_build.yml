# Workflow to validate the Spack package definition for FTorch
name: Spack Package Validation

# Controls when the workflow will run
on:
  # Triggers the workflow on pushes to the "main" branch, i.e., PR merges
  push:
    branches: [ "main" ]

  # Triggers the workflow on pushes to open pull requests with code changes
  pull_request:
    paths:
      # This workflow
      - '.github/workflows/spack_build.yml'
      # Package definition
      - 'package.py'

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Cancel jobs running if new commits are pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

# Write permissions are not required
permissions: {}

jobs:
  # Job 1: Validate Spack package syntax and concretization
  spack-validate:
    name: Validate Spack Package
    runs-on: ubuntu-22.04
    timeout-minutes: 10

    steps:
      - name: Checkout FTorch repository
        uses: actions/checkout@v5

      - name: Setup Spack
        uses: spack/setup-spack@v2
        with:
          ref: develop
          color: true

      - name: Add FTorch package to Spack
        run: |
          # Create a custom Spack repository for FTorch
          mkdir -p ftorch-repo/packages/ftorch
          cp package.py ftorch-repo/packages/ftorch/
          
          # Create repo.yaml for the custom repo
          echo "repo:" > ftorch-repo/repo.yaml
          echo "  namespace: ftorch" >> ftorch-repo/repo.yaml
          
          # Add the custom repo to Spack
          spack repo add $(pwd)/ftorch-repo

      - name: Validate package syntax
        run: |
          # Check that the package is recognized
          spack info ftorch
          
          # Validate package Python syntax
          python -m py_compile package.py
          echo "Package syntax is valid"

      - name: Test concretization
        run: |
          # Test that the package can be concretized with different variants
          echo "=== Testing concretization: ftorch@main ~cuda ~tests ==="
          spack spec ftorch@main~cuda~tests
          
          echo "=== Testing concretization: ftorch@main ~cuda +tests ==="
          spack spec ftorch@main~cuda+tests
          
          echo "=== Testing concretization: ftorch@main +cuda ~tests ==="
          spack spec ftorch@main+cuda~tests
          
          echo "All concretization tests passed!"

  # Job 2: Build FTorch with CMake using pip-installed PyTorch
  # This validates the build process works, similar to other CI tests
  cmake-build:
    name: CMake Build Test
    runs-on: ubuntu-22.04
    timeout-minutes: 15

    steps:
      - name: Checkout FTorch repository
        uses: actions/checkout@v5

      - name: Install system packages
        run: |
          sudo apt-get update
          sudo apt-get install -y gfortran cmake

      - name: Setup Python and install PyTorch
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PyTorch via pip
        run: |
          python -m pip install --upgrade pip
          pip install torch --index-url https://download.pytorch.org/whl/cpu

      - name: Build FTorch with CMake
        run: |
          # Get PyTorch path
          TORCH_PATH=$(python -c "import torch; print(torch.__path__[0])")
          
          mkdir build && cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH="${TORCH_PATH}" \
            -DCMAKE_INSTALL_PREFIX="${PWD}/install"
          cmake --build .
          cmake --install .

      - name: Verify installation
        run: |
          # Verify key files were installed
          ls -la build/install/lib/
          ls -la build/install/include/
          
          if [[ ! -f "build/install/lib/libftorch.so" ]]; then
            echo "ERROR: libftorch.so not found"
            exit 1
          fi
          
          if [[ ! -f "build/install/include/ctorch.h" ]]; then
            echo "ERROR: ctorch.h not found"
            exit 1
          fi
          
          echo "Build and installation successful!"
