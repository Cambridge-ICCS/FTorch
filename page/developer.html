<!-- -*- mode: jinja2 -*- -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta name="description" content="A library for coupling (Py)Torch machine learning models to Fortran">
    <meta name="author" content="ICCS Cambridge" >
    <link rel="icon" href="../favicon.png">

    <title>Developer Guide &ndash; FTorch</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <!-- Font Awesome -->
    <link href="../css/fontawesome.min.css" rel="stylesheet">
    <link href="../css/brands.min.css" rel="stylesheet">
    <link href="../css/regular.min.css" rel="stylesheet">
    <link href="../css/solid.min.css" rel="stylesheet">
    <link href="../css/v4-font-face.min.css" rel="stylesheet">
    <link href="../css/v4-shims.min.css" rel="stylesheet">
    <!-- MathJax -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { equationNumbers: { autoNumber: "AMS" } }
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.9/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async
            integrity="sha256-DViIOMYdwlM/axqoGDPeUyf0urLoHMN4QACBKyB58Uw=" crossorigin="anonymous"></script>
    <!-- Other scripts and stylesheets -->
    <link href="../css/local.css" rel="stylesheet">
    <link href="../css/pygments.css" rel="stylesheet">
    <script src="../js/svg-pan-zoom.min.js"></script>
  </head>

  <body>

    <!-- Fixed navbar -->
    <div class="container-fluid mb-sm-4 mb-xl-2">
      <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
          <a class="navbar-brand" href="../index.html">FTorch </a>
          <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar"
                  aria-expanded="false" aria-controls="navbar" aria-label="Toggle navigation">
                  <span class="navbar-toggler-icon">
          </button>

          <div id="navbar" class="navbar-collapse collapse">
            <ul class="navbar-nav">
                <li class="nav-item"><a class="nav-link" href="index.html">User Guide</a></li>
                  <li class="nav-item">
                    <a class="nav-link" href="../lists/files.html">Source Files</a>
                  </li>
                <li class="nav-item">
                  <a class="nav-link" href="../lists/modules.html">Modules</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../lists/procedures.html">Procedures</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../lists/types.html">Derived Types</a>
                </li>
            </ul>
              <div class="d-flex align-items-end flex-grow-1">
                <form action="../search.html" role="search" class="ms-auto">
                  <input type="text" class="form-control" aria-label="Search" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
                </form>
              </div>
          </div><!--/.nav-collapse -->
        </div>
      </nav>
    </div>

    <div class="container">
  <div class="row">
    <h1>Developer Guide</h1>
    <div class="container p-2 mb-4 bg-light border rounded-3">
      <div class="row align-items-center justify-content-between">
        <div class="col">
          <ul class="list-inline" style="margin-bottom:0px; display:inline">
          </ul>
        </div>
        <div class="col">
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb justify-content-end mb-0">
                <li class="breadcrumb-item"><a href='index.html'>User Guide</a></li>
              <li class="breadcrumb-item active" aria-current="page">Developer Guide</li>
            </ol>
          </nav>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
      <div class="col-3">
        <div class="card card-body bg-light" id="sidebar-toc">
          <ul class="nav flex-column align-items">
            <li class="nav-item">
              <a class="nav-link" href="index.html">User Guide</a>
            </li>
          </ul>
          <hr>
          <nav class="nav nav-pills flex-column">
              <a class="nav-link" href="LICENSE.html">FTorch License</a>
              <a class="nav-link" href="archive.html">News archive</a>
              <a class="nav-link" href="changelog.html">FTorch Changelog</a>
              <a class="nav-link" href="cmake.html">Installation and Build Process</a>
              <a class="nav-link active disabled" href="developer.html">Developer Guide</a>
              <a class="nav-link" href="examples.html">Examples</a>
              <a class="nav-link" href="gpu.html">GPU Support</a>
              <a class="nav-link" href="hpc.html">Guidance for use in High Performance Computing (HPC)</a>
              <a class="nav-link" href="offline.html">Offline training</a>
              <a class="nav-link" href="online.html">Online training</a>
              <a class="nav-link" href="presentations.html">Presentations</a>
              <a class="nav-link" href="tensor.html">Tensor API</a>
              <a class="nav-link" href="testing.html">FTorch test suite</a>
              <a class="nav-link" href="transposing.html">When to transpose data</a>
              <a class="nav-link" href="troubleshooting.html">Troubleshooting</a>
              <a class="nav-link" href="updates.html">Recent API Changes</a>
          </nav>
        </div>
      </div>

    <div class="col-9" id='text'>
      <p>If you would like to contribute to the FTorch project, or modify the code at a deeper
level, please see below for guidance.</p>
<div class="toc">
<ul>
<li><a href="#getting-involved">Getting involved</a><ul>
<li><a href="#code-of-conduct">Code of Conduct</a></li>
</ul>
</li>
<li><a href="#extending-the-api">Extending the API</a><ul>
<li><a href="#installing-developer-requirements">Installing developer requirements</a></li>
<li><a href="#fortran-source-and-fypp">Fortran source and Fypp</a></li>
<li><a href="#torch-c-api">Torch C++ API</a></li>
<li><a href="#gpu-device-handling">GPU device handling</a></li>
<li><a href="#git-hook">git hook</a></li>
<li><a href="#code-style">Code style</a></li>
<li><a href="#general-guidelines">General guidelines</a></li>
</ul>
</li>
<li><a href="#documentation">Documentation</a><ul>
<li><a href="#versioning-and-changelog">Versioning and Changelog</a></li>
<li><a href="#api-documentation">API Documentation</a></li>
</ul>
</li>
</ul>
</div>
<h2 id="getting-involved">Getting involved</h2>
<p>Contributions and collaborations are welcome.</p>
<p>For bugs, feature requests, and clear suggestions for improvement please
<a href="https://github.com/Cambridge-ICCS/FTorch/issues/new/choose">open an issue</a>.</p>
<p>If you have built something upon <em>FTorch</em> that would be useful to others, or can
address an <a href="https://github.com/Cambridge-ICCS/FTorch/issues">open issue</a>, please
<a href="https://github.com/Cambridge-ICCS/FTorch/fork">fork the repository</a> and open a
pull request.</p>
<h3 id="code-of-conduct">Code of Conduct</h3>
<p>Everyone participating in the FTorch project, and in particular in the
issue tracker, pull requests, and social media activity, is expected to treat other
people with respect and, more generally, to follow the guidelines articulated in the
<a href="https://www.python.org/psf/codeofconduct/">Python Community Code of Conduct</a>.</p>
<h2 id="extending-the-api">Extending the API</h2>
<p>If you have a Torch functionality that you wish to bring in from the C++ API to
the FTorch Fortran API the steps are generally as follows:</p>
<ul>
<li>Modify <code>ctorch.cpp</code> to create a C++ version of the function that accesses <code>torch::&lt;item&gt;</code>.</li>
<li>Add the function to the header file <code>ctorch.h</code></li>
<li>Modify <code>ftorch.fypp</code> to create a Fortran version of the function
  that binds to the version in <code>ctorch.cpp</code>.</li>
</ul>
<p>Details of C++ functionalities available to be wrapped can be found
in the <a href="https://pytorch.org/cppdocs/">LibTorch C++ API</a>.</p>
<p>As this is an open-source project we appreciate any contributions
back from users that have extended the functionality.
If you have done something but don't know where to start with
open-source contributions please get in touch!<sup>*</sup></p>
<p><sup>*</sup><em>Our preferred method of contact is via Github issues and discussions,
but if you are unfamiliar with this you can <a href="mailto:jwa34@cam.ac.uk">email ICCS</a>
asking for the FTorch developers.</em></p>
<h3 id="installing-developer-requirements">Installing developer requirements</h3>
<p>Most of the development tools (<a href="#fortran-source-and-fypp">pre-processing</a>,<a href="#code-style">code styling</a>) happen to be pip-installable <a href="https://github.com/Cambridge-ICCS/FTorch/blob/main/requirements-dev.txt">packages</a>. You can install them by running</p>
<div class="codehilite"><pre><span></span><code>pip install -r requirements-dev.txt
</code></pre></div>

<p>inside a Python virtual environment from the base FTorch directory.</p>
<h3 id="fortran-source-and-fypp">Fortran source and Fypp</h3>
<p>The Fortran source code for FTorch is contained in <code>src/ftorch.F90</code>.
However, this file should not be edited directly, but instead generated from
<code>src/ftorch.fypp</code>.
This is a file that is set up to be run through the
<a href="https://fypp.readthedocs.io/en/stable/index.html">Fypp</a> preprocessor.
We use this because we want to create a pleasant interface of single function calls.
The nature of Fortran means that this requires a lot of repeated combinations of
array shapes and data types under interface structures.
By using Fypp we can generate these programatically.</p>
<p>Fypp is a pip-installable package that comes bundled with the <a href="#installing-developer-requirements">developer requirements</a>.</p>
<p>To generate the Fortran code run:</p>
<div class="codehilite"><pre><span></span><code>fypp src/ftorch.fypp src/ftorch.F90
</code></pre></div>

<p><em>Note: Generally it would be advisable to provide only the <code>.fypp</code> source code to
reduce duplication and confusion. However, because it is a relatively small file
and many of our users wish to </em>"clone-and-go"<em> rather than develop, we provide both.<br>
Development should only take place in <code>ftorch.fypp</code>, however.</em></p>
<h3 id="torch-c-api">Torch C++ API</h3>
<p>When extending or modifying functionality related to C++ header and/or source
files <code>src/ctorch.h</code> and <code>src/ctorch.cpp</code>, we refer to the Torch
<a href="https://pytorch.org/cppdocs">C++ documentation</a> and more specifically the
<a href="https://pytorch.org/cppdocs/api/library_root.html">C++ API documentation</a>
pages on the PyTorch website for details.</p>
<h3 id="gpu-device-handling">GPU device handling</h3>
<p>GPU device-specific code is handled in FTorch using codes defined in the root
<code>CMakeLists.txt</code> file:</p>
<div class="codehilite"><pre><span></span><code><span class="nb">set</span><span class="p">(</span><span class="s">GPU_DEVICE_NONE</span><span class="w"> </span><span class="s">0</span><span class="p">)</span>
<span class="nb">set</span><span class="p">(</span><span class="s">GPU_DEVICE_CUDA</span><span class="w"> </span><span class="s">1</span><span class="p">)</span>
<span class="nb">set</span><span class="p">(</span><span class="s">GPU_DEVICE_XPU</span><span class="w"> </span><span class="s">12</span><span class="p">)</span>
<span class="nb">set</span><span class="p">(</span><span class="s">GPU_DEVICE_MPS</span><span class="w"> </span><span class="s">13</span><span class="p">)</span>
</code></pre></div>

<p>These device codes are chosen to be consistent with the numbering used in
PyTorch (see
https://github.com/pytorch/pytorch/blob/main/c10/core/DeviceType.h). When a user
specifies <code>-DGPU_DEVICE=XPU</code> (for example) in the FTorch CMake build, this is
mapped to the appropriate device code (in this case 12). The chosen device code
and all other ones defined are passed to the C++ compiler in the following step:</p>
<div class="codehilite"><pre><span></span><code><span class="nb">target_compile_definitions</span><span class="p">(</span>
<span class="w">  </span><span class="o">${</span><span class="nv">LIB_NAME</span><span class="o">}</span>
<span class="w">  </span><span class="s">PRIVATE</span><span class="w"> </span><span class="o">${</span><span class="nv">COMPILE_DEFS</span><span class="o">}</span><span class="w"> </span><span class="s">GPU_DEVICE=</span><span class="o">${</span><span class="nv">GPU_DEVICE_CODE</span><span class="o">}</span>
<span class="w">          </span><span class="s">GPU_DEVICE_NONE=</span><span class="o">${</span><span class="nv">GPU_DEVICE_NONE</span><span class="o">}</span><span class="w"> </span><span class="s">GPU_DEVICE_CUDA=</span><span class="o">${</span><span class="nv">GPU_DEVICE_CUDA</span><span class="o">}</span>
<span class="w">          </span><span class="s">GPU_DEVICE_XPU=</span><span class="o">${</span><span class="nv">GPU_DEVICE_XPU</span><span class="o">}</span><span class="w"> </span><span class="s">GPU_DEVICE_MPS=</span><span class="o">${</span><span class="nv">GPU_DEVICE_MPS</span><span class="o">}</span><span class="p">)</span>
</code></pre></div>

<p>The chosen device code will enable the appropriate C pre-processor conditions in
the C++ source so that that the code relevant to that device type becomes
active.</p>
<p>An example illustrating why this approach was taken is that if we removed the
device codes and pre-processor conditions and tried to build with a CPU-only or
CUDA LibTorch installation then compile errors would arise from the use of the
<code>torch::xpu</code> module in <code>src/ctorch.cpp</code>.</p>
<h3 id="git-hook">git hook</h3>
<p>In order to streamline the process of uploading we provide a pre-commit hook in
<a href="https://github.com/Cambridge-ICCS/FTorch/blob/main/.githooks/pre-commit"><code>.githooks/pre-commit</code></a>.
This will check that both the <code>.fypp</code> and <code>.f90</code> files have been updated together in a
synchronous fashion before a commmit can take place.
If this does not happen then the second line of defence (GitHub continuous integration)
will fail following the commit.</p>
<p>Use of the hook is not automatic and needs to be enabled by the developer
(after they have inspected it and are happy with its contents).
Hooks can be enabled by placing them in the <code>.git</code> directory with the following commands:</p>
<div class="codehilite"><pre><span></span><code>cp .githooks/pre-commit .git/hooks/
chmod +x .git/hooks/pre-commit
</code></pre></div>

<h3 id="code-style">Code style</h3>
<p>FTorch source code is subject to a number of static analysis checks to ensure that it
conforms to quality and legibility. These tools are a mixture of formatters and linters.</p>
<p>The tools we use are as follows on a language-by-language basis:</p>
<ul>
<li>Fortran: <a href="https://github.com/PlasmaFAIR/fortitude">fortitude</a></li>
<li>C++: <a href="https://clang.llvm.org/docs/ClangFormat.html">clang-format</a> and <a href="https://clang.llvm.org/extra/clang-tidy/">clang-tidy</a></li>
<li>C: <a href="https://clang.llvm.org/docs/ClangFormat.html">clang-format</a> and <a href="https://clang.llvm.org/extra/clang-tidy/">clang-tidy</a></li>
<li>Python: <a href="https://docs.astral.sh/ruff/">ruff</a></li>
<li>Shell: <a href="https://github.com/koalaman/shellcheck">ShellCheck</a></li>
<li>CMake: <a href="https://github.com/cheshirekow/cmake_format">cmake-format</a></li>
<li>GitHub Actions workflows: <a href="https://woodruffw.github.io/zizmor">zizmor</a></li>
</ul>
<p>Instructions on installing these tools can be found in their respective documentations.</p>
<p>Note that all but ShellCheck may be installed with pip. Check out the <a href="#installing-developer-requirements">dev tools installation section</a> for instructions on how to do so.</p>
<p>Contributors should run them over their code and ensure that it conforms before submitting
a pull request. If there is a good reason to ignore a particular rule this should be
justified in the pull request and ideally documented in the code.</p>
<p>There is a GitHub action as part of the continuous integration that will perform these
checks on all opened pull requests before they are merged.</p>
<h3 id="general-guidelines">General guidelines</h3>
<ul>
<li>Match optional argument defaults between Fortran, C, and C++<br>
  (<a href="https://en.wikipedia.org/wiki/Principle_of_least_astonishment">principle of least astonishment</a>).</li>
<li>Handle <code>torch::Error</code> and <code>std::exception</code> in the C++ functions by catching and
  printing to screen before exiting cleanly.</li>
</ul>
<h2 id="documentation">Documentation</h2>
<h3 id="versioning-and-changelog">Versioning and Changelog</h3>
<p>FTorch has follows <a href="https://semver.org/">semantic versioning</a>.</p>
<ul>
<li>Major releases for API changes</li>
<li>Minor releases periodically for new features</li>
<li>Patches for bug fixes</li>
</ul>
<p>The project version should be updated accordingly through the <code>PACKAGE_VERSION</code> in
CMakeLists.txt for each new release.</p>
<p>A log of notable changes to the software is kept in <code>CHANGELOG.md</code>.
This follows the conventions of <a href="https://keepachangelog.com/">Keep a Changelog</a> and should
be updated by contributors and maintainers as part of a pull request when appropriate.
<br>
"Notable" includes new features, bugfixes, dependency updates etc.
<br>
"Notable" does not cover typo corrections, documentation rephrasing and restyling,
or correction of other minor infelicities that do not impact the user or developer.</p>
<p>New minor releases are made when deemed appropriate by maintainers by adding a tag to
the commit and creating a corresponding GitHub Release.
The minor number of the version should be incremented, the entry for the version
finalised in the changelog, and a clean log for 'Unreleased' changes created.</p>
<p>New patch releases are made whenever a bugfix is merged.
The patch number of the version should be incremented, a tag attached to the commit,
and a note made under the current 'Unreleased' patches header in the changelog.</p>
<h3 id="api-documentation">API Documentation</h3>
<p>The API documentation for FTorch is generated using 
<a href="https://forddocs.readthedocs.io/en/latest/">FORD</a>.
For detailed information refer to the 
<a href="https://forddocs.readthedocs.io/en/latest/user_guide/index.html">FORD User Guide</a>,
but as a quick-start:</p>
<ul>
<li><code>!!</code> is used to signify documentation.</li>
<li>Documentation comes <em>after</em> whatever it is documenting (inline or subsequent line).</li>
<li>Documentation can precede an item if designated using <code>!&gt;</code>.</li>
</ul>
<p>FORD is pip installable:</p>
<div class="codehilite"><pre><span></span><code>pip install ford
</code></pre></div>

<p>FORD uses <a href="https://graphviz.org">graphviz</a> to generate dependency graphs from the Fortran
source code<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup>. 
For this, you will need to install it on your system - see the <a href="https://graphviz.org/download/">installation guide</a> for your platform.</p>
<p>To generate the documentation run:</p>
<div class="codehilite"><pre><span></span><code>ford FTorch.md
</code></pre></div>

<p>from the root of the repository.</p>
<p><code>FTorch.md</code> is the FORD index file, API documentation is automatically generated, and
any further items are contained in <code>pages/</code> as markdown files.</p>
<p>Documentation of the C functions in <code>ctorch.h</code> is provided
by <a href="https://www.doxygen.nl/index.html">Doxygen</a>.</p>
<p>Note that we need to define the macros for GPU devices that are passed to <code>ftorch.F90</code>
via the C preprocessor in <code>FTorch.md</code> to match those in the CMakeLists.txt.</p>
<p>If you are building documentation locally and wish FORD to continue when it encounters
errors, you can change the <code>dbg</code> setting in the <code>FTorch.md</code> file to <code>true</code>. Note that
in this case the documentation may build but be incomplete. Please pay close attention
to the warnings.</p>
<div class="footnote">
<hr>
<ol>
<li id="fn:1">
<p>Note: If FORD cannot locate the graphviz executable (it is not a hard dependency) it will generate a warning.&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>
    </div>
  </div>
      <hr>
    </div> <!-- /container -->
    <footer>
      <div class="container">
        <div class="row justify-content-between">
          <div class="col">
            <p>
              FTorch
 was developed by ICCS Cambridge<br>              &copy; 2025 <a rel="license" href="https://opensource.org/licenses/MIT">MIT</a>
</p>
          </div>
          <div class="col">
            <p class="text-end">
              Documentation generated by
              <a href="https://github.com/Fortran-FOSS-Programmers/ford">FORD</a>
            </p>
          </div>
        </div>
        <br>
      </div> <!-- /container -->
    </footer>
  </body>
</html>